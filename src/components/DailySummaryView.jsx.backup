import { useState, useEffect } from 'react'
import supabase from '../firebase'
import { utils as XLSXUtils, writeFile } from 'xlsx'

function DailySummaryView({ user, onLogout }) {
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0])
  const [selectedShift, setSelectedShift] = useState('all')
  const [loading, setLoading] = useState(false)
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å raw data
  const [vipEntries, setVipEntries] = useState([])
  const [computerEntries, setComputerEntries] = useState([])
  
  // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
  const [summary, setSummary] = useState({
    vip: { total: 0, transfer: 0, cash: 0, count: 0 },
    computer: { total: 0, transfer: 0, cash: 0, count: 0 },
    grand: { total: 0, transfer: 0, cash: 0 }
  })

  
  const shifts = {
    '1': { name: '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤', time: '10:00-19:00', color: 'from-yellow-400 to-orange-500' },
    '2': { name: '‡∏Å‡∏∞‡πÄ‡∏¢‡πá‡∏ô', time: '19:00-01:00', color: 'from-purple-400 to-pink-500' },
    '3': { name: '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å', time: '01:00-10:00', color: 'from-blue-400 to-indigo-500' }
  }

  const getShiftFromTime = (timeStr) => {
    if (!timeStr) return null
    const hour = parseInt(timeStr.split(':')[0])
    if (hour >= 10 && hour < 19) return '1'
    if (hour >= 19 || hour < 1) return '2'
    if (hour >= 1 && hour < 10) return '3'
    return null
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  useEffect(() => {
    loadData()
  }, [selectedDate])

  // Realtime subscription
  useEffect(() => {
    if (!supabase) return

    const vipChannel = supabase
      .channel('vip_summary')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'customers_history' }, loadData)
      .subscribe()

    const computerChannel = supabase
      .channel('computer_summary')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'computer_zone_history' }, loadData)
      .subscribe()

    return () => {
      supabase.removeChannel(vipChannel)
      supabase.removeChannel(computerChannel)
    }
  }, [selectedDate])

  const loadData = async () => {
    if (!supabase) return
    
    try {
      setLoading(true)

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• VIP
      const { data: vipData, error: vipError } = await supabase
        .from('customers_history')
        .select('*')
        .eq('session_date', selectedDate)
        .order('start_time', { ascending: false })

      if (vipError) throw vipError

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Computer Zone
      const { data: computerData, error: computerError } = await supabase
        .from('computer_zone_history')
        .select('*')
        .eq('session_date', selectedDate)
        .order('created_at', { ascending: false })

      if (computerError) throw computerError

      setVipEntries(vipData || [])
      setComputerEntries(computerData || [])

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
      calculateSummary(vipData || [], computerData || [])

    } catch (error) {
      console.error('Error loading data:', error)
      alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message)
    } finally {
      setLoading(false)
    }
  }

  const calculateSummary = (vipData, computerData) => {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VIP
    const vipSummary = vipData.reduce((acc, entry) => {
      const cost = parseFloat(entry.final_cost) || 0
      const isTransfer = (entry.payment_method || 'transfer') === 'transfer'
      
      acc.total += cost
      acc.count += 1
      if (isTransfer) acc.transfer += cost
      else acc.cash += cost
      
      return acc
    }, { total: 0, transfer: 0, cash: 0, count: 0 })

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Computer
    const computerSummary = computerData.reduce((acc, entry) => {
      const transfer = parseFloat(entry.transfer_amount) || 0
      const cash = parseFloat(entry.cash_amount) || 0
      
      acc.total += (transfer + cash)
      acc.transfer += transfer
      acc.cash += cash
      acc.count += 1
      
      return acc
    }, { total: 0, transfer: 0, cash: 0, count: 0 })

    // ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const grandTotal = vipSummary.total + computerSummary.total
    const grandTransfer = vipSummary.transfer + computerSummary.transfer
    const grandCash = vipSummary.cash + computerSummary.cash

    setSummary({
      vip: vipSummary,
      computer: computerSummary,
      grand: { total: grandTotal, transfer: grandTransfer, cash: grandCash }
    })
  }

  // Filter ‡∏ï‡∏≤‡∏°‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const getFilteredData = () => {
    if (selectedShift === 'all') {
      return { vip: vipEntries, computer: computerEntries }
    }

    const filteredVip = vipEntries.filter(e => 
      e.start_time && getShiftFromTime(e.start_time) === selectedShift
    )
    
    const filteredComputer = computerEntries.filter(e => e.shift === selectedShift)

    return { vip: filteredVip, computer: filteredComputer }
  }

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏∞‡∏ó‡∏µ‡πà filter
  const getFilteredSummary = () => {
    const { vip, computer } = getFilteredData()
    
    const vipSum = vip.reduce((acc, e) => {
      const cost = parseFloat(e.final_cost) || 0
      const isTransfer = (e.payment_method || 'transfer') === 'transfer'
      acc.total += cost
      if (isTransfer) acc.transfer += cost
      else acc.cash += cost
      return acc
    }, { total: 0, transfer: 0, cash: 0 })

    const computerSum = computer.reduce((acc, e) => {
      const transfer = parseFloat(e.transfer_amount) || 0
      const cash = parseFloat(e.cash_amount) || 0
      acc.total += (transfer + cash)
      acc.transfer += transfer
      acc.cash += cash
      return acc
    }, { total: 0, transfer: 0, cash: 0 })

    return {
      vip: vipSum,
      computer: computerSum,
      grand: {
        total: vipSum.total + computerSum.total,
        transfer: vipSum.transfer + computerSum.transfer,
        cash: vipSum.cash + computerSum.cash
      }
    }
  }

  const exportToExcel = () => {
    const { vip, computer } = getFilteredData()
    const filtered = getFilteredSummary()

    // VIP Sheet
    const vipSheet = vip.map((entry, index) => ({
      '‡∏•‡∏≥‡∏î‡∏±‡∏ö': index + 1,
      '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤': entry.name || '-',
      '‡∏´‡πâ‡∏≠‡∏á': entry.room || '-',
      '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°': entry.start_time || '-',
      '‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î': entry.end_time || '-',
      '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)': entry.duration_minutes || 0,
      '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢': entry.final_cost || 0,
      '‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢': entry.payment_method === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : '‡πÇ‡∏≠‡∏ô',
      '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': entry.note || '-'
    }))

    // Computer Sheet
    const computerSheet = computer.map((entry, index) => ({
      '‡∏•‡∏≥‡∏î‡∏±‡∏ö': index + 1,
      '‡∏Å‡∏∞': entry.shift ? `‡∏Å‡∏∞ ${entry.shift}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
      '‡πÇ‡∏≠‡∏ô': entry.transfer_amount || 0,
      '‡∏™‡∏î': entry.cash_amount || 0,
      '‡∏£‡∏ß‡∏°': entry.total_cost || 0,
      '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': entry.added_by || '-',
      '‡πÄ‡∏ß‡∏•‡∏≤': entry.start_time || '-'
    }))

    // Summary Sheet
    const summarySheet = [
      { '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': '‡∏´‡πâ‡∏≠‡∏á VIP', '‡πÇ‡∏≠‡∏ô (‡∏ø)': filtered.vip.transfer, '‡∏™‡∏î (‡∏ø)': filtered.vip.cash, '‡∏£‡∏ß‡∏° (‡∏ø)': filtered.vip.total },
      { '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': 'Computer Zone', '‡πÇ‡∏≠‡∏ô (‡∏ø)': filtered.computer.transfer, '‡∏™‡∏î (‡∏ø)': filtered.computer.cash, '‡∏£‡∏ß‡∏° (‡∏ø)': filtered.computer.total },
      { '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': '=== ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===', '‡πÇ‡∏≠‡∏ô (‡∏ø)': filtered.grand.transfer, '‡∏™‡∏î (‡∏ø)': filtered.grand.cash, '‡∏£‡∏ß‡∏° (‡∏ø)': filtered.grand.total }
    ]

    const wb = XLSXUtils.book_new()
    XLSXUtils.book_append_sheet(wb, XLSXUtils.json_to_sheet(summarySheet), '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î')
    XLSXUtils.book_append_sheet(wb, XLSXUtils.json_to_sheet(vipSheet), '‡∏´‡πâ‡∏≠‡∏á VIP')
    XLSXUtils.book_append_sheet(wb, XLSXUtils.json_to_sheet(computerSheet), 'Computer Zone')

    const fileName = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î_${selectedDate}${selectedShift !== 'all' ? `_‡∏Å‡∏∞${selectedShift}` : ''}.xlsx`
    writeFile(wb, fileName)
  }
    })
  }

  const cancelEdit = () => {
    setEditingEntry(null)
    setEditFormData({
      customerName: '',
      hours: '',
      transferAmount: '',
      cashAmount: '',
      startTime: '',
      description: '',
      shift: 'all'
    })
  }

  const updateComputerEntry = async (id) => {
    if (!editFormData.hours || (!editFormData.transferAmount && !editFormData.cashAmount)) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô')
      return
    }

    try {
      const transferAmt = parseFloat(editFormData.transferAmount) || 0
      const cashAmt = parseFloat(editFormData.cashAmount) || 0
      const totalCost = transferAmt + cashAmt
      const shift = editFormData.shift || 'all'  // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ shift ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const customerName = editFormData.customerName.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'

      const updatePayload = {
        customer_name: customerName,
        hours: parseFloat(editFormData.hours),
        transfer_amount: transferAmt,
        cash_amount: cashAmt,
        total_cost: totalCost,
        shift: shift,
        start_time: editFormData.startTime || null,
        description: editFormData.description || `${customerName} - ${editFormData.hours} ‡∏ä‡∏°.`,
        updated_at: new Date().toISOString()
      }

      console.log('Updating computer zone entry:', { id, payload: updatePayload })

      const { data, error } = await supabase
        .from('computer_zone_history')
        .update(updatePayload)
        .eq('id', id)
        .select()

      console.log('Update result:', { data, error })

      if (error) {
        console.error('Update error details:', error)
        alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ: ' + error.message)
        return
      }

      if (!data || data.length === 0) {
        alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç')
        return
      }

      // Realtime ‡∏à‡∏∞ reload ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      cancelEdit()
      alert('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    } catch (error) {
      console.error('Error updating entry:', error)
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
    }
  }

  // Helpers for history (VIP)
  const formatDateTimeLocal = (value) => {
    if (!value) return ''
    const d = new Date(value)
    const iso = d.toISOString()
    return iso.slice(0, 16) // YYYY-MM-DDTHH:mm
  }

  const startEditHistory = (entry) => {
    setEditingHistoryId(entry.id)
    setHistoryForm({
      name: entry.name || '',
      room: entry.room || '',
      addedBy: entry.added_by || '',
      startTime: formatDateTimeLocal(entry.start_time),
      endTime: formatDateTimeLocal(entry.end_time),
      durationMinutes: entry.duration_minutes || '',
      finalCost: entry.final_cost || '',
      isPaid: !!entry.is_paid,
      endReason: entry.end_reason || 'in_progress',
      note: entry.note || ''
    })
  }

  const cancelHistoryEdit = () => {
    setEditingHistoryId(null)
    setHistoryForm({
      name: '',
      room: '',
      addedBy: '',
      startTime: '',
      endTime: '',
      durationMinutes: '',
      finalCost: '',
      isPaid: false,
      endReason: 'in_progress',
      note: ''
    })
  }

  const updateHistoryEntry = async (id) => {
    if (!historyForm.finalCost) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (final_cost)')
      return
    }

    try {
      const payload = {
        name: historyForm.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        room: historyForm.room || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
        added_by: historyForm.addedBy || null,
        start_time: historyForm.startTime ? new Date(historyForm.startTime).toISOString() : null,
        end_time: historyForm.endTime ? new Date(historyForm.endTime).toISOString() : null,
        duration_minutes: historyForm.durationMinutes ? parseFloat(historyForm.durationMinutes) : null,
        final_cost: parseFloat(historyForm.finalCost) || 0,
        is_paid: !!historyForm.isPaid,
        end_reason: historyForm.endReason || 'completed',
        note: historyForm.note || '',
        updated_at: new Date().toISOString()
      }

      const { error } = await supabase
        .from('customers_history')
        .update(payload)
        .eq('id', id)

      if (error) throw error

      cancelHistoryEdit()
      alert('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç History ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    } catch (error) {
      console.error('Error updating history:', error)
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
    }
  }

  const deleteHistoryEntry = async (id) => {
    if (!window.confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return

    try {
      const { error } = await supabase
        .from('customers_history')
        .delete()
        .eq('id', id)

      if (error) throw error
      alert('‚úÖ ‡∏•‡∏ö History ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    } catch (error) {
      console.error('Error deleting history:', error)
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
    }
  }

  const exportToExcel = () => {
    try {
      const data = []
      const header = ['#', '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', '‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)', '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏ö‡∏≤‡∏ó)', '‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']
      
      summaryData.computerZoneEntries.forEach((entry, index) => {
        data.push([
          index + 1,
          entry.customer_name,
          entry.hours,
          (parseFloat(entry.transfer_amount) || 0).toFixed(2),
          (parseFloat(entry.cash_amount) || 0).toFixed(2),
          (parseFloat(entry.total_cost) || 0).toFixed(2),
          entry.start_time || '-',
          entry.description || '-',
          entry.added_by,
          new Date(entry.created_at).toLocaleDateString('th-TH')
        ])
      })

      // Add summary rows
      data.push([])
      data.push(['‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î', '', '', '', '', '', '', '', '', ''])
      data.push(['Game Zone (‡πÇ‡∏≠‡∏ô)', '', '', summaryData.gameZoneTransfer.toFixed(2), summaryData.gameZoneCash.toFixed(2), summaryData.gameZoneTotal.toFixed(2), '', '', '', ''])
      data.push(['Computer Zone (‡πÇ‡∏≠‡∏ô)', '', '', summaryData.computerZoneTransfer.toFixed(2), summaryData.computerZoneCash.toFixed(2), summaryData.computerZoneTotal.toFixed(2), '', '', '', ''])
      data.push(['‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô', '', '', summaryData.grandTransfer.toFixed(2), summaryData.grandCash.toFixed(2), summaryData.grandTotal.toFixed(2), '', '', '', ''])

      const ws = XLSXUtils.aoa_to_sheet([header, ...data])
      const wb = XLSXUtils.book_new()
      XLSXUtils.book_append_sheet(wb, ws, 'Daily Summary')
      
      const fileName = `daily-summary-${summaryData.date}.xlsx`
      writeFile(wb, fileName)
      alert('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    } catch (error) {
      console.error('Error exporting:', error)
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
    }
  }

  const exportRangeToExcel = () => {
    try {
      const data = []
      const header = ['#', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢']
      
      rangeData.entries.forEach((entry, index) => {
        data.push([
          index + 1,
          new Date(entry.summary_date).toLocaleDateString('th-TH'),
          entry.hours,
          entry.cost,
          entry.description || '-',
          entry.added_by
        ])
      })

      // Add summary rows
      data.push([])
      data.push(['‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + new Date(rangeData.startDate).toLocaleDateString('th-TH') + ' - ' + new Date(rangeData.endDate).toLocaleDateString('th-TH') + ')', '', '', '', '', ''])
      data.push(['‡∏´‡πâ‡∏≠‡∏á VIP', '', '', rangeData.totalGameZone.toFixed(2), '', ''])
      data.push(['Computer Zone', '', '', rangeData.totalComputerZone.toFixed(2), '', ''])
      data.push(['‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô', '', '', rangeData.grandTotal.toFixed(2), '', ''])

      const ws = XLSXUtils.aoa_to_sheet([header, ...data])
      const wb = XLSXUtils.book_new()
      XLSXUtils.book_append_sheet(wb, ws, 'Range Summary')
      
      const fileName = `summary-${rangeData.startDate}-to-${rangeData.endDate}.xlsx`
      writeFile(wb, fileName)
      alert('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    } catch (error) {
      console.error('Error exporting:', error)
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4 animate-spin">‚è≥</div>
          <p className="text-white text-xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-3 md:p-6">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="flex justify-between items-center mb-8 pt-4">
          <div className="text-left">
            <h1 className="text-4xl md:text-5xl font-bold text-white drop-shadow-2xl">
              üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </h1>
            <p className="text-gray-300 text-lg mt-2">
              ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </p>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => window.history.back()}
              className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-all"
            >
              ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>
            <button
              onClick={onLogout}
              className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all"
            >
              ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
          </div>
        </div>

        {/* View Mode Tabs */}
        <div className="flex gap-4 mb-6">
          <button
            onClick={() => setViewMode('daily')}
            className={`px-6 py-3 font-bold rounded-lg transition-all ${
              viewMode === 'daily'
                ? 'bg-blue-500 text-white shadow-lg'
                : 'bg-gray-600 text-gray-200 hover:bg-gray-700'
            }`}
          >
            üìÖ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
          </button>
          <button
            onClick={() => setViewMode('range')}
            className={`px-6 py-3 font-bold rounded-lg transition-all ${
              viewMode === 'range'
                ? 'bg-blue-500 text-white shadow-lg'
                : 'bg-gray-600 text-gray-200 hover:bg-gray-700'
            }`}
          >
            üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô
          </button>
        </div>

        {/* Daily Summary View */}
        {viewMode === 'daily' && (
          <>
            {/* Date Picker and Shift Selector */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div className="bg-white rounded-lg p-4 shadow-lg">
                <label className="block text-gray-700 font-bold mb-2">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input
                  type="date"
                  value={summaryData.date}
                  onChange={(e) => setSummaryData({ ...summaryData, date: e.target.value })}
                  className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                />
              </div>
              
              <div className="bg-white rounded-lg p-4 shadow-lg">
                <label className="block text-white-700 font-bold mb-2">üîÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏∞</label>
                <select
                  value={selectedShift}
                  onChange={(e) => setSelectedShift(e.target.value)}
                  className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white"
                >
                  <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option value="1">‡∏Å‡∏∞ 1 (10:00-19:00)</option>
                  <option value="2">‡∏Å‡∏∞ 2 (19:00-01:00)</option>
                  <option value="3">‡∏Å‡∏∞ 3 (01:00-10:00)</option>
                </select>
              </div>
            </div>

            {/* Summary Cards with Payment Breakdown */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              {/* Game Zone Summary */}
              <div className="bg-gradient-to-br from-green-400 to-emerald-600 rounded-2xl p-6 shadow-2xl text-white">
                <h2 className="text-lg font-semibold mb-4 opacity-90">üéÆ ‡∏´‡πâ‡∏≠‡∏á VIP</h2>
                <div className="space-y-2 mb-4">
                  <div className="flex justify-between items-center">
                    <span>üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô:</span>
                    <span className="font-bold">‡∏ø{summaryData.gameZoneTransfer.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span>üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span>
                    <span className="font-bold">‡∏ø{summaryData.gameZoneCash.toFixed(2)}</span>
                  </div>
                  <div className="border-t border-white/30 pt-2 flex justify-between items-center">
                    <span className="font-bold">‡∏£‡∏ß‡∏°:</span>
                    <span className="text-2xl font-bold">‡∏ø{summaryData.gameZoneTotal.toFixed(2)}</span>
                  </div>
                </div>
              </div>

              {/* Computer Zone Summary */}
              <div className="bg-gradient-to-br from-blue-400 to-cyan-600 rounded-2xl p-6 shadow-2xl text-white">
                <h2 className="text-lg font-semibold mb-4 opacity-90">üíª Computer Zone</h2>
                <div className="space-y-2 mb-4">
                  <div className="flex justify-between items-center">
                    <span>üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô:</span>
                    <span className="font-bold">‡∏ø{summaryData.computerZoneTransfer.toFixed(2)}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span>üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span>
                    <span className="font-bold">‡∏ø{summaryData.computerZoneCash.toFixed(2)}</span>
                  </div>
                  <div className="border-t border-white/30 pt-2 flex justify-between items-center">
                    <span className="font-bold">‡∏£‡∏ß‡∏°:</span>
                    <span className="text-2xl font-bold">‡∏ø{summaryData.computerZoneTotal.toFixed(2)}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Grand Total with Breakdown */}
            <div className="bg-gradient-to-br from-yellow-400 to-orange-600 rounded-2xl p-8 shadow-2xl text-white mb-8">
              <h2 className="text-2xl font-bold mb-6">üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-white/20 rounded-lg p-4">
                  <p className="text-sm opacity-90">üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô (Transfer)</p>
                  <p className="text-4xl font-bold">‡∏ø{summaryData.grandTransfer.toFixed(2)}</p>
                </div>
                <div className="bg-white/20 rounded-lg p-4">
                  <p className="text-sm opacity-90">üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (Cash)</p>
                  <p className="text-4xl font-bold">‡∏ø{summaryData.grandCash.toFixed(2)}</p>
                </div>
                <div className="bg-white/20 rounded-lg p-4 border-2 border-white">
                  <p className="text-sm opacity-90">üìä ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                  <p className="text-4xl font-bold">‡∏ø{summaryData.grandTotal.toFixed(2)}</p>
                </div>
              </div>
            </div>

            {/* Shift Details */}
            {selectedShift !== 'all' && shiftSummary[selectedShift] && (
              <div className="mb-8">
                <h2 className="text-2xl font-bold mb-4 text-white">
                  üîÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏∞ {selectedShift} ({shifts[selectedShift]?.start}-{shifts[selectedShift]?.end})
                </h2>
                
                <div className="bg-white rounded-2xl shadow-xl p-6 border-4 border-blue-300">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    {/* Computer Zone */}
                    <div className="bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl p-5 shadow-lg text-white">
                      <h3 className="text-lg font-bold mb-3">üíª Computer Zone</h3>
                      <div className="space-y-2">
                        <div className="flex justify-between">
                          <span>‡πÇ‡∏≠‡∏ô:</span>
                          <span className="font-bold">‡∏ø{shiftSummary[selectedShift].computerTransfer.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span>‡∏™‡∏î:</span>
                          <span className="font-bold">‡∏ø{shiftSummary[selectedShift].computerCash.toFixed(2)}</span>
                        </div>
                        <div className="border-t border-white/30 pt-2 flex justify-between font-bold text-lg">
                          <span>‡∏£‡∏ß‡∏°:</span>
                          <span>‡∏ø{shiftSummary[selectedShift].computerTotal.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>

                    {/* Game Zone VIP */}
                    <div className="bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl p-5 shadow-lg text-white">
                      <h3 className="text-lg font-bold mb-3">üéÆ ‡∏´‡πâ‡∏≠‡∏á VIP</h3>
                      <div className="space-y-2">
                        <div className="flex justify-between">
                          <span>‡πÇ‡∏≠‡∏ô:</span>
                          <span className="font-bold">‡∏ø{shiftSummary[selectedShift].gameZoneTransfer.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span>‡∏™‡∏î:</span>
                          <span className="font-bold">‡∏ø{shiftSummary[selectedShift].gameZoneCash.toFixed(2)}</span>
                        </div>
                        <div className="border-t border-white/30 pt-2 flex justify-between font-bold text-lg">
                          <span>‡∏£‡∏ß‡∏°:</span>
                          <span>‡∏ø{shiftSummary[selectedShift].gameZoneTotal.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>

                    {/* Total Transfer */}
                    <div className="bg-gradient-to-br from-purple-400 to-pink-600 rounded-xl p-5 shadow-lg text-white">
                      <h3 className="text-lg font-bold mb-3">üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</h3>
                      <p className="text-4xl font-bold">
                        ‡∏ø{(shiftSummary[selectedShift].computerTransfer + shiftSummary[selectedShift].gameZoneTransfer).toFixed(2)}
                      </p>
                    </div>

                    {/* Total Cash + Grand Total */}
                    <div className="bg-gradient-to-br from-yellow-400 to-orange-600 rounded-xl p-5 shadow-lg text-white">
                      <h3 className="text-lg font-bold mb-3">üí≥ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                      <div className="text-4xl font-bold">
                        ‡∏ø{(shiftSummary[selectedShift].computerTotal + shiftSummary[selectedShift].gameZoneTotal).toFixed(2)}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Export Button */}
            <div className="mb-6">
              <button
                onClick={exportToExcel}
                className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg transform hover:scale-105 active:scale-95 flex items-center gap-2"
              >
                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
              </button>
            </div>

            {/* Computer Zone Details with Staff Names */}
            <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8 mb-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl md:text-3xl font-bold text-gray-800">
                  üíª ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </h2>
                <button
                  onClick={() => setShowComputerZone(!showComputerZone)}
                  className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all"
                >
                  {showComputerZone ? '‚ñº ‡∏ã‡πà‡∏≠‡∏ô' : '‚ñ∂ ‡πÅ‡∏™‡∏î‡∏á'}
                </button>
              </div>
              {showComputerZone && (
              <>
                {(() => {
                  // Filter entries by selected shift
                  const filteredEntries = selectedShift === 'all' 
                    ? summaryData.computerZoneEntries 
                    : summaryData.computerZoneEntries.filter(entry => entry.shift === selectedShift)
                  
                  if (filteredEntries.length === 0) {
                    return (
                      <div className="text-center py-12 text-gray-400">
                        <div className="text-5xl mb-4">üíª</div>
                        <p className="text-xl font-bold">
                          {selectedShift === 'all' 
                            ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'
                            : `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏∞ ${selectedShift} (${shifts[selectedShift]?.name})`
                          }
                        </p>
                      </div>
                    )
                  }
                  
                  // Calculate totals for filtered entries
                  const filteredTransfer = filteredEntries.reduce((sum, e) => sum + (parseFloat(e.transfer_amount) || 0), 0)
                  const filteredCash = filteredEntries.reduce((sum, e) => sum + (parseFloat(e.cash_amount) || 0), 0)
                  const filteredTotal = filteredTransfer + filteredCash
                  
                  return (
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gray-100 border-b-2 border-gray-300">
                            <th className="px-4 py-3 text-left text-gray-700 font-bold">#</th>
                            <th className="px-4 py-3 text-left text-gray-700 font-bold">üë§ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th className="px-4 py-3 text-center text-gray-700 font-bold">üîÑ ‡∏Å‡∏∞</th>
                            <th className="px-4 py-3 text-right text-gray-700 font-bold">üí∏ ‡πÇ‡∏≠‡∏ô</th>
                            <th className="px-4 py-3 text-right text-gray-700 font-bold">üí≥ ‡∏™‡∏î</th>
                            <th className="px-4 py-3 text-right text-gray-700 font-bold">üìä ‡∏£‡∏ß‡∏°</th>
                            <th className="px-4 py-3 text-center text-gray-700 font-bold">üïê ‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th className="px-4 py-3 text-center text-gray-700 font-bold">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredEntries.map((entry, index) => {
                        const shiftColor = {
                          '1': 'bg-green-100 text-green-700',
                          '2': 'bg-orange-100 text-orange-700',
                          '3': 'bg-purple-100 text-purple-700'
                        }[entry.shift || 'all'] || 'bg-gray-100 text-gray-700'
                        
                        return (
                          <tr key={entry.id} className="border-b border-gray-200 hover:bg-blue-50 transition-colors">
                            <td className="px-4 py-3 text-gray-700 font-semibold">{index + 1}</td>
                            <td className="px-4 py-3">
                              <span className="inline-block bg-blue-200 text-blue-800 px-3 py-1 rounded-full font-bold text-xs">
                                {entry.added_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-center">
                              <span className={`inline-block px-3 py-1 rounded-lg font-bold text-xs ${shiftColor}`}>
                                ‡∏Å‡∏∞ {entry.shift || 'all'}
                              </span>
                            </td>
                            <td className="px-4 py-3 text-right text-blue-600 font-bold">‡∏ø{(parseFloat(entry.transfer_amount) || 0).toFixed(2)}</td>
                            <td className="px-4 py-3 text-right text-orange-600 font-bold">‡∏ø{(parseFloat(entry.cash_amount) || 0).toFixed(2)}</td>
                            <td className="px-4 py-3 text-right text-gray-700 font-bold text-lg">‡∏ø{(parseFloat(entry.total_cost) || 0).toFixed(2)}</td>
                            <td className="px-4 py-3 text-center text-gray-600">{entry.start_time || '-'}</td>
                            <td className="px-4 py-3 text-center">
                              <button
                                onClick={() => startEditEntry(entry)}
                                className="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs mr-1 font-semibold"
                                title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                              >
                                ‚úèÔ∏è
                              </button>
                              <button
                                onClick={() => deleteComputerEntry(entry.id)}
                                className="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold"
                                title="‡∏•‡∏ö"
                              >
                                üóëÔ∏è
                              </button>
                            </td>
                          </tr>
                        )
                      })}
                          </tbody>
                        <tfoot>
                          <tr className="bg-blue-100 border-t-2 border-gray-300 font-bold text-gray-700">
                            <td colSpan="4" className="px-4 py-3">
                              ‡∏£‡∏ß‡∏°{selectedShift !== 'all' ? ` ‡∏Å‡∏∞ ${selectedShift}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                            </td>
                            <td className="px-4 py-3 text-right text-blue-600">‡∏ø{filteredTransfer.toFixed(2)}</td>
                            <td className="px-4 py-3 text-right text-orange-600">‡∏ø{filteredCash.toFixed(2)}</td>
                            <td className="px-4 py-3 text-right text-lg">‡∏ø{filteredTotal.toFixed(2)}</td>
                            <td></td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  )
                })()}
              </>
              )}
            </div>

            {/* Game Zone Details by Room */}
            {Object.keys(summaryData.gameZoneByRoom).length > 0 && (
              <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8 mb-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-800">
                    üéÆ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏´‡πâ‡∏≠‡∏á VIP ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á
                  </h2>
                  <button
                    onClick={() => setShowVIPByRoom(!showVIPByRoom)}
                    className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all"
                  >
                    {showVIPByRoom ? '‚ñº ‡∏ã‡πà‡∏≠‡∏ô' : '‚ñ∂ ‡πÅ‡∏™‡∏î‡∏á'}
                  </button>
                </div>
                {showVIPByRoom && (() => {
                  // Filter VIP entries by selected shift
                  const filteredVipEntries = selectedShift === 'all'
                    ? summaryData.gameZoneEntries
                    : summaryData.gameZoneEntries.filter(entry => {
                        if (entry.start_time) {
                          const shift = getShiftFromTime(entry.start_time)
                          return shift === selectedShift
                        }
                        return false
                      })
                  
                  // Recalculate room totals from filtered entries
                  const filteredRoomData = {}
                  let filteredVipTotal = 0
                  let filteredVipTransfer = 0
                  let filteredVipCash = 0
                  
                  filteredVipEntries.forEach(record => {
                    const cost = parseFloat(record.final_cost) || 0
                    const room = record.room || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á'
                    const paymentMethod = record.payment_method || 'transfer'
                    
                    filteredVipTotal += cost
                    if (paymentMethod === 'transfer') {
                      filteredVipTransfer += cost
                    } else {
                      filteredVipCash += cost
                    }
                    
                    if (!filteredRoomData[room]) {
                      filteredRoomData[room] = { total: 0, transfer: 0, cash: 0, count: 0 }
                    }
                    filteredRoomData[room].total += cost
                    filteredRoomData[room].count += 1
                    if (paymentMethod === 'transfer') {
                      filteredRoomData[room].transfer += cost
                    } else {
                      filteredRoomData[room].cash += cost
                    }
                  })
                  
                  if (Object.keys(filteredRoomData).length === 0) {
                    return (
                      <div className="text-center py-12 text-gray-400">
                        <div className="text-5xl mb-4">üéÆ</div>
                        <p className="text-xl font-bold">
                          {selectedShift === 'all' 
                            ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á VIP ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'
                            : `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏∞ ${selectedShift} (${shifts[selectedShift]?.name})`
                          }
                        </p>
                      </div>
                    )
                  }
                  
                  return (
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-gray-100 border-b-2 border-gray-300">
                            <th className="px-4 py-3 text-left text-gray-700 font-bold">üö™ ‡∏´‡πâ‡∏≠‡∏á</th>
                            <th className="px-4 py-3 text-center text-gray-700 font-bold">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th className="px-4 py-3 text-right text-gray-700 font-bold">üí∏ ‡πÇ‡∏≠‡∏ô</th>
                            <th className="px-4 py-3 text-right text-gray-700 font-bold">üí≥ ‡∏™‡∏î</th>
                            <th className="px-4 py-3 text-right text-gray-700 font-bold">üí∞ ‡∏£‡∏ß‡∏°</th>
                          </tr>
                        </thead>
                        <tbody>
                          {Object.entries(filteredRoomData).map(([room, data]) => {
                            const percentage = filteredVipTotal > 0 
                              ? ((data.total / filteredVipTotal) * 100).toFixed(1)
                              : 0
                            return (
                              <tr key={room} className="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                                <td className="px-4 py-3 text-gray-700 font-semibold">{room}</td>
                                <td className="px-4 py-3 text-center text-gray-700">{data.count}</td>
                                <td className="px-4 py-3 text-right text-blue-600 font-bold">‡∏ø{data.transfer.toFixed(2)}</td>
                                <td className="px-4 py-3 text-right text-orange-600 font-bold">‡∏ø{data.cash.toFixed(2)}</td>
                                <td className="px-4 py-3 text-right text-gray-700 font-bold text-lg">‡∏ø{data.total.toFixed(2)}</td>
                              </tr>
                            )
                          })}
                        </tbody>
                        <tfoot>
                          <tr className="bg-green-100 border-t-2 border-gray-300 font-bold text-gray-700">
                            <td className="px-4 py-3">
                              ‡∏£‡∏ß‡∏°{selectedShift !== 'all' ? ` ‡∏Å‡∏∞ ${selectedShift}` : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                            </td>
                            <td className="px-4 py-3 text-center">
                              {Object.values(filteredRoomData).reduce((sum, data) => sum + data.count, 0)}
                            </td>
                            <td className="px-4 py-3 text-right text-blue-600">‡∏ø{filteredVipTransfer.toFixed(2)}</td>
                            <td className="px-4 py-3 text-right text-orange-600">‡∏ø{filteredVipCash.toFixed(2)}</td>
                            <td className="px-4 py-3 text-right text-lg">‡∏ø{filteredVipTotal.toFixed(2)}</td>
                            <td className="px-4 py-3 text-right">100%</td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  )
                })()}
              </div>
            )}

            {/* Info Box */}
            <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
              <p className="text-blue-800 font-semibold">
                üí° <strong>Tip:</strong> ‡∏ï‡∏±‡∏ß ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏ñ‡∏≤‡∏°‡∏•‡∏µ‡πÇ‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πâ‡∏≤‡∏ö
              </p>
            </div>
          </>
        )}

        {/* Range Summary View */}
        {viewMode === 'range' && (
          <>
            {/* Date Range Picker */}
            <div className="bg-white rounded-lg p-4 mb-6 shadow-lg">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-gray-700 font-bold mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                  <input
                    type="date"
                    value={rangeData.startDate}
                    onChange={(e) => setRangeData({ ...rangeData, startDate: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 font-bold mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                  <input
                    type="date"
                    value={rangeData.endDate}
                    onChange={(e) => setRangeData({ ...rangeData, endDate: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>
              </div>
            </div>

            {/* Summary Cards for Range */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div className="bg-gradient-to-br from-green-400 to-emerald-600 rounded-2xl p-6 shadow-2xl text-white">
                <h2 className="text-sm font-semibold mb-2 opacity-90">üéÆ ‡∏´‡πâ‡∏≠‡∏á VIP</h2>
                <p className="text-3xl font-bold">‡∏ø{rangeData.totalGameZone.toFixed(2)}</p>
                <p className="text-xs opacity-75 mt-1">‡πÇ‡∏≠‡∏ô: ‡∏ø{rangeData.totalGameZoneTransfer.toFixed(2)}</p>
                <p className="text-xs opacity-75">‡∏™‡∏î: ‡∏ø{rangeData.totalGameZoneCash.toFixed(2)}</p>
              </div>

              <div className="bg-gradient-to-br from-blue-400 to-cyan-600 rounded-2xl p-6 shadow-2xl text-white">
                <h2 className="text-sm font-semibold mb-2 opacity-90">üíª Computer Zone</h2>
                <p className="text-3xl font-bold">‡∏ø{rangeData.totalComputerZone.toFixed(2)}</p>
                <p className="text-xs opacity-75 mt-1">‡πÇ‡∏≠‡∏ô: ‡∏ø{rangeData.totalComputerZoneTransfer.toFixed(2)}</p>
                <p className="text-xs opacity-75">‡∏™‡∏î: ‡∏ø{rangeData.totalComputerZoneCash.toFixed(2)}</p>
              </div>

              <div className="bg-gradient-to-br from-purple-400 to-pink-600 rounded-2xl p-6 shadow-2xl text-white">
                <h2 className="text-sm font-semibold mb-2 opacity-90">üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</h2>
                <p className="text-xs opacity-75 mt-1">‡πÇ‡∏≠‡∏ô: ‡∏ø{rangeData.grandTransfer.toFixed(2)}</p>

                <h2 className="text-sm font-semibold mb-2 opacity-90">üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h2>
                <p className="text-xs opacity-75 mt-1">‡∏™‡∏î: ‡∏ø{rangeData.grandCash.toFixed(2)}</p>
              </div>

              <div className="bg-gradient-to-br from-yellow-400 to-orange-600 rounded-2xl p-6 shadow-2xl text-white">
                <h2 className="text-sm font-semibold mb-2 opacity-90">üìä ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <p className="text-3xl font-bold">‡∏£‡∏ß‡∏°: ‡∏ø{rangeData.grandTotal.toFixed(2)}</p>
              </div>
            </div>

            {/* Export Button for Range */}
            <div className="mb-6">
              <button
                onClick={exportRangeToExcel}
                className="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg transform hover:scale-105 active:scale-95 flex items-center gap-2"
              >
                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
              </button>
            </div>
          </>
        )}

        {/* Edit Computer Zone Entry Modal */}
        {editingEntry && (
          <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-3 z-50">
            <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
              
              <div className="space-y-3">
                {/* Customer Name */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                  <input
                    type="text"
                    value={editFormData.customerName || ''}
                    onChange={(e) => setEditFormData({...editFormData, customerName: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>

                {/* Hours */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">‚è±Ô∏è ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</label>
                  <input
                    type="number"
                    step="0.5"
                    value={editFormData.hours || ''}
                    onChange={(e) => setEditFormData({...editFormData, hours: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>

                {/* Transfer Amount */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editFormData.transferAmount || ''}
                    onChange={(e) => setEditFormData({...editFormData, transferAmount: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>

                {/* Cash Amount */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editFormData.cashAmount || ''}
                    onChange={(e) => setEditFormData({...editFormData, cashAmount: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>

                {/* Start Time */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">üïê ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                  <input
                    type="time"
                    value={editFormData.startTime || ''}
                    onChange={(e) => setEditFormData({...editFormData, startTime: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                  />
                </div>

                {/* Shift */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">üîÑ ‡∏Å‡∏∞</label>
                  <select
                    value={editFormData.shift || 'all'}
                    onChange={(e) => setEditFormData({...editFormData, shift: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-white"
                  >
                    <option value="all">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏∞</option>
                    <option value="1">‡∏Å‡∏∞ 1 (10:00-19:00)</option>
                    <option value="2">‡∏Å‡∏∞ 2 (19:00-01:00)</option>
                    <option value="3">‡∏Å‡∏∞ 3 (01:00-10:00)</option>
                  </select>
                </div>

                {/* Description */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-1">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                  <textarea
                    value={editFormData.description || ''}
                    onChange={(e) => setEditFormData({...editFormData, description: e.target.value})}
                    className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                    rows="2"
                  />
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-2 mt-4">
                <button
                  onClick={() => updateComputerEntry(editingEntry)}
                  className="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all"
                >
                  ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button
                  onClick={cancelEdit}
                  className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-all"
                >
                  ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default DailySummaryView
